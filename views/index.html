<!DOCTYPE html>
<html lang="en">

<head>



  <title>Hola</title>


  <style>
    html,
    body {
      overflow: hidden;
      margin: 0;
      width: 100%;
      height: 100%;

    }

    .player {
      position: absolute;
      bottom: 1rem;
      width: 100%;

    }

    .timeControl {
      position: absolute;
      bottom: 0;
      padding: 1rem;


    }

    .timeControl>input {
      width: 50px;
    }
  </style>
</head>

<body>


  <!-- <audio class="player" controls>
    <source src="music/hello.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio> -->

  <div class="timeControl">
    <input id="travelTo" placeholder="1000" />
    <button onclick="travelTo( travelTo.value || 1000)">Go</button>

  </div>

  <canvas id="myCanvas"></canvas>

  <script>


    const tEndIntro = 22700
    const tStartChangeColor = 46600
    const tEndChangeColor = 54500



    const onKeyDown = (e) => {
      // console.log(e)
      switch (e.code) {
        case 'Digit1':
          travelTo(tEndIntro)
          break;
        case 'Space':
          console.log('Space')
          nextWord()
          break;
        case 'KeyP':
          console.log(timeNow - startTime)
          break;
        case 'KeyQ':
          console.log('Q')
          sizeFrontMax++
          break;
        case 'KeyS':
          console.log('S')
          start()

          break;
        case 'ArrowLeft':
          console.log('left')
          break;
        case 'ArrowRight':
          console.log('right')
          break;
        case 'ArrowUp':
          speed += 0.05
          console.log('speed', speed)
          break;
        case 'ArrowDown':
          speed -= 0.05
          console.log('speed', speed)
          break;
      }
    }

    document.addEventListener("keydown", onKeyDown);



    const DEBUG = true
    var N, speed0, speed1, speed, startTime, timePrev, timeNow, timeSong, dt, canvas, ctx
    var songStarted = false
    var colors



    var starsFront = [];
    var starsBack = [];
    var starsFarBack = [];

    let toWrite = ''



    class Color {
      constructor(r, g, b) {
        this.r = r;
        this.g = g;
        this.b = b;

      }


      increment(i) {
        this.r += i
        this.g += i
        this.b += i

      }



      get rgb() {
        return `rgb(${this.r}, ${this.g}, ${this.b})`
      }
    }



    function start() {
      if (music.paused) {
        if (music.currentTime == 0) {
          music.currentTime += 0.096

          speed = speed0
        }          
          startTime = performance.now() - (timeSong || 0)

        music.play().then(songStarted = true);
      }
      else {
        music.pause()
        songStarted = false
      }






    }

    function init() {
      console.log('init')
      N = 200
      speed0 = 2.8
      speed1 = 0.01
      speed = speed1
      timePrev = 0

      colors = {
        background: new Color(0, 0, 0),
        starsFront: new Color(255, 255, 255)

      }


      music = new Audio('music/hello.mp3');


      initCanvas()


      initStars()

      window.requestAnimationFrame(() => { update(); render() })
    }



    // INITATORS

    function initCanvas() {
      canvas = document.querySelector("canvas");
      canvas.width = document.body.clientWidth;
      canvas.height = document.body.clientHeight;
      canvas.addEventListener('click', start)
      ctx = canvas.getContext("2d");
    }

    function initStars() {
      for (var i = 0; i < N; ++i) {

        starsFront.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          z: 0.5 + Math.random() * 1,
        });
      }
      for (var i = 0; i < N; ++i) {
        starsBack.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          z: 3 + Math.random() * 1
        });
      }
      for (var i = 0; i < 12000; ++i) {
        starsFarBack.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          z: 80 + Math.random() * 1
        });
      }

    }


    // UPDATORS
    function updateStarsFront(dt) {
      for (star in starsFront) {
        var star = starsFront[star];
        const starSpeed = speed / star.z

        star.y += starSpeed * dt
        if (star.y > canvas.height) { star.y = star.y % canvas.height } else if (star.y < 0) { star.y = canvas.height + (star.y % canvas.height) }
        if (star.x > canvas.width) { star.x = star.x % canvas.width } else if (star.x < 0) { star.x = canvas.width + (star.x % canvas.width) }

      }
    }

    function updateStarsBack(dt) {
      for (star in starsBack) {
        var star = starsBack[star];
        const starSpeed = speed / star.z

        star.y += starSpeed * dt
        if (star.y > canvas.height) { star.y = star.y % canvas.height } else if (star.y < 0) { star.y = canvas.height + (star.y % canvas.height) }
        if (star.x > canvas.width) { star.x = star.x % canvas.width } else if (star.x < 0) { star.x = canvas.width + (star.x % canvas.width) }
      }
    }


    function updateStarsFarBack(dt) {
      for (star in starsFarBack) {
        var star = starsFarBack[star];
        const starSpeed = speed / star.z

        star.y += starSpeed * dt
        if (star.y > canvas.height) { star.y = star.y % canvas.height } else if (star.y < 0) { star.y = canvas.height + (star.y % canvas.height) }
        if (star.x > canvas.width) { star.x = star.x % canvas.width } else if (star.x < 0) { star.x = canvas.width + (star.x % canvas.width) }
      }
    }

    var sizeFrontMax = 18
    var sizeBackMax = 84

    const lyrics = [
      'Fly',
      'In the universe',
      'I want to',
      'Fly',
      'There is no war',
      'There is no',
      'crime',
      'Please come with me',
      'and take my',
      'hand',
      'Sal ahora mismo y déjalo',
      'Vente al universo conmigo',
      'Escápate y olvídalo',
      'Vente al universo conmigo',
      'Prepárate y vámonos',
      'Vente al universo conmigo',
      'Quiero volar'



    ]

    let currentVerseIndex = 0
    let currentWordIndex = 0
    let currentVerseList = lyrics[0].split(' ')
    let currentWord = currentVerseList[0]
    let currentTextBuffer = ''


    function travelTo(toTime_ms) {
      const toTime = toTime_ms / 1000
      music.currentTime = toTime
      startTime = timeNow - toTime_ms





    }
    function nextWord() {
      if (currentWordIndex > currentVerseList.length - 1) {
        currentWordIndex = 0
        currentVerseIndex++
        currentVerseList = lyrics[currentVerseIndex].split(' ')
        currentTextBuffer = ''


      }
      currentWord = currentVerseList[currentWordIndex]
      currentTextBuffer += currentWord + (currentWordIndex == currentVerseList.length - 1 ? '' : ' ')
      currentWordIndex++


    }

    // DRAWERS
    function drawDebug() {



      const what =
        `music.currentTime : 
timeSong :
startTime:
timeNow:`
      const value =
        `${music.currentTime.toFixed(2)}
${(timeSong / 1000 || 0).toFixed(2)}
${(startTime || 0).toFixed(0)}
${timeNow.toFixed(0)}
${(timeSong/1000 || 0 - music.currentTime).toFixed(4)}
`
      const lines = what.split('\n');
      const lines2 = value.split('\n');

      const Nlines = lines.length
      const lineHeight = 16
      const lenghtWhat = 120
      const lenghtValue = 60

      ctx.fillStyle = "black";

      ctx.fillRect(0, 0, lenghtWhat, Nlines * lineHeight)

      ctx.fillRect(lenghtWhat, 0, lenghtValue, Nlines * lineHeight)
      ctx.fillStyle = "cyan";

      ctx.font = "10px courier";
      ctx.textAlign = "start"



      for (var i = 0; i < lines.length; i++) {
        ctx.fillText(lines[i], 5, 10 + (i * lineHeight));

        ctx.fillText(lines2[i], lenghtWhat, 10 + (i * lineHeight));
      }

    }

    function drawStarsFront(stars) {
      ctx.fillStyle = colors.starsFront.rgb;
      for (star in stars) {
        var star = stars[star];
        ctx.fillRect(star.x, star.y, sizeFrontMax / star.z, sizeFrontMax / star.z);
      }

    }

    function drawLyrics() {
      ctx.fillStyle = "red";

      ctx.font = "70px arial";
      ctx.textAlign = "start"

      let textSize = ctx.measureText(lyrics[currentVerseIndex]).width

      ctx.fillText(currentTextBuffer, canvas.width / 2 - textSize / 2, canvas.height / 2);

    }

    function drawStarsBack(stars) {
      ctx.fillStyle = "grey"
      for (star in stars) {
        var star = stars[star];
        ctx.fillRect(star.x, star.y, sizeBackMax / star.z, sizeBackMax / star.z);

      }
    }

    function drawStarsFarBack(stars) {
      ctx.fillStyle = "white"
      for (star in stars) {
        var star = stars[star];
        ctx.fillRect(star.x, star.y, 0.2, 0.2);

      }
    }

    function drawBackground() {
      ctx.fillStyle = colors.background.rgb;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    //UPDATE
    function update() {

      timeNow = performance.now()
      var dt = timeNow - timePrev
      timePrev = timeNow


      if (songStarted) {

        timeSong = timeNow - startTime







        // intro deacceleration
        // if (timeSong < tEndIntro) {
          speed = speed0 - 0.0001229 * (timeSong > tEndIntro ? tEndIntro: timeSong)
          
        // }


        // change colors 1
        if (timeSong > tStartChangeColor && timeSong < tEndChangeColor) {
          console.log('sex')
          const backgroundColorIncrement = (255 / (tEndChangeColor - tStartChangeColor)) * dt
          const starsFrontColorIncrement = (-255 / (tEndChangeColor - tStartChangeColor)) * dt
          colors.background.increment(backgroundColorIncrement)
          colors.starsFront.increment(starsFrontColorIncrement)

        }
      }






      updateStarsBack(dt)
      updateStarsFront(dt)
      // updateStarsFarBack(dt)

    }

    let farBackStars = false
    //RENDER
    function render() {

      drawBackground()
      if (farBackStars) drawStarsFarBack(starsFarBack)
      drawStarsBack(starsBack)


      drawLyrics()



      drawStarsFront(starsFront)



      if (DEBUG) {
        drawDebug()
      }

      window.requestAnimationFrame(() => { update(); render() });
    }






    function mainLoop() {

      update()
      render()

    }



    init()


  </script>


</body>

</html>